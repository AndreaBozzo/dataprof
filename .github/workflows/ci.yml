name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  # Exclude staging - it has its own workflow

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: read

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      matrix:
        test-type: [core, integration]
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-prefix: ci

      - name: Setup system dependencies
        uses: ./.github/actions/setup-system-deps

      - name: Run tests
        uses: ./.github/actions/run-tests
        with:
          test-type: ${{ matrix.test-type }}
          timeout: 15

  # Lint and format checks
  quality-checks:
    name: Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-prefix: ci

      - name: Check formatting
        run: |
          echo "ğŸ¨ Checking code formatting..."
          cargo fmt --all -- --check
          echo "âœ… Formatting check passed"

      - name: Run clippy
        run: |
          echo "ğŸ“ Running clippy analysis..."
          cargo clippy --lib --tests --all-features -- -D warnings -A deprecated
          echo "âœ… Clippy analysis passed"

      - name: Check documentation
        run: |
          echo "ğŸ“š Checking documentation..."
          cargo doc --no-deps --document-private-items
          echo "âœ… Documentation check passed"

  # Security audit
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-prefix: ci

      - name: Install cargo-audit
        run: cargo install --locked cargo-audit

      - name: Run security audit
        run: |
          echo "ğŸ” Running security audit..."
          cargo audit
          echo "âœ… Security audit passed"
