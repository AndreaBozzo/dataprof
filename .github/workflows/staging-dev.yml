name: Staging Development Workflow

on:
  push:
    branches: [ staging ]
  pull_request:
    branches: [ staging ]
  # Allow manual triggering
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

permissions:
  contents: read

jobs:
  # Quick feedback for developers
  quick-check:
    name: Quick Development Checks
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: staging-${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          staging-${{ runner.os }}-cargo-

    - name: Check code formatting
      run: cargo fmt --all -- --check

    - name: Run Clippy lints (core features)
      run: cargo clippy --lib -- -D warnings

    - name: Run Clippy lints (PostgreSQL features)
      run: cargo clippy --lib --features postgres -- -D warnings

    - name: Run Clippy lints (MySQL features)
      run: cargo clippy --lib --features mysql -- -D warnings

    - name: Run Clippy lints (SQLite features)
      run: cargo clippy --lib --features sqlite -- -D warnings

    - name: Run Clippy lints (Apache Arrow features)
      run: cargo clippy --lib --features arrow -- -D warnings

    - name: Check for common issues
      run: |
        echo "ğŸ” Checking for unsafe unwrap() calls..."
        UNWRAP_FILES=$(find src -name "*.rs" -exec grep -l "\.unwrap()" {} \; 2>/dev/null || true)
        if [ -n "$UNWRAP_FILES" ]; then
          echo "âŒ Found unwrap() calls in:"
          echo "$UNWRAP_FILES"
          exit 1
        else
          echo "âœ… No unsafe unwrap() calls found"
        fi

        echo "ğŸ” Checking for TODO/FIXME comments..."
        if grep -r -i "TODO\|FIXME" src/; then
          echo "âš ï¸  Found TODO/FIXME comments - consider addressing before merge"
        fi

        echo "âœ… Code quality checks passed"

  # Simplified testing for staging
  test-suite:
    name: Test Suite
    runs-on: ubuntu-latest
    needs: quick-check

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust stable
      uses: dtolnay/rust-toolchain@stable

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: staging-${{ hashFiles('**/Cargo.lock') }}

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libsqlite3-dev
        # Install DuckDB
        wget https://github.com/duckdb/duckdb/releases/download/v1.1.3/libduckdb-linux-amd64.zip
        unzip libduckdb-linux-amd64.zip
        sudo cp libduckdb.so /usr/local/lib/
        sudo cp duckdb.h /usr/local/include/
        sudo ldconfig

    - name: Run core tests
      run: cargo test --lib --verbose

    - name: Run integration tests
      run: cargo test --test "*" --verbose

    - name: Run error handling tests
      run: cargo test --test error_handling_simple --verbose

    - name: Run data quality tests
      run: cargo test --test data_quality_simple --verbose

    - name: Run database tests
      run: |
        cargo test --features postgres --lib --verbose
        cargo test --features sqlite --lib --verbose

    - name: Run Arrow integration tests
      run: |
        echo "ğŸš€ Testing Apache Arrow integration..."
        cargo test --features arrow --lib --verbose
        cargo test --features arrow test_arrow_api_integration --verbose
        echo "âœ… Arrow integration tests completed"

  # Light performance check
  performance-check:
    name: Basic Performance Check
    runs-on: ubuntu-latest
    needs: test-suite
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust stable
      uses: dtolnay/rust-toolchain@stable

    - name: Basic build test
      run: |
        echo "ğŸš€ Quick build check..."
        cargo build --release
        echo "âœ… Build completed successfully"

    - name: Arrow performance validation
      run: |
        echo "âš¡ Testing Arrow performance integration..."
        cargo build --release --features arrow
        echo "ğŸ” Running Arrow memory efficiency test..."
        cargo test --release --features arrow test_arrow_memory_efficiency -- --nocapture
        echo "âœ… Arrow performance validation completed"

    - name: Run performance benchmarks
      run: |
        echo "ğŸ“Š Running performance benchmarks..."
        cargo bench --no-run
        echo "âœ… Benchmark build completed"

  # Final status check
  staging-ready:
    name: Staging Ready
    runs-on: ubuntu-latest
    needs: [quick-check, test-suite, performance-check]
    if: always()

    steps:
    - name: Check overall status
      run: |
        echo "ğŸ“Š Staging Development Workflow Summary"
        echo "âœ… Quick checks: ${{ needs.quick-check.result }}"
        echo "âœ… Test suite: ${{ needs.test-suite.result }}"
        echo "âš¡ Performance: ${{ needs.performance-check.result || 'skipped' }}"

        if [[ "${{ needs.quick-check.result }}" == "success" && "${{ needs.test-suite.result }}" == "success" ]]; then
          echo "ğŸ‰ Staging checks passed! Ready for development work."
        else
          echo "âŒ Some checks failed. Please review before continuing development."
          exit 1
        fi
